---
layout: post
title: Designing Rudaux
date: 2018-08-19
excerpt: Canvas and JupyterHub Integration in UBC's Data Science 100.
heroImage: paint-strokes.jpg
heroColor: '#525659'
imageAuthor: Samuel Zeller
imageLink: https://unsplash.com/@samuelzeller
---

<!-- close content tag -->
</div>

<div class="card post-info">
  <div class="card-content">
    <div class="content">
      <blockquote>
        This post is focused on the motivation and design process in building Rudaux. For information on how to use Rudaux to integrate Canvas and JupyterHub, please read <a href="using-rudaux"><em>Using Rudaux</em></a>.
      </blockquote>
    </div>
  </div>
  <footer class="card-footer">
    <a href='https://samhinshaw.github.io/rudaux-docs/' class='card-footer-item'>
      <span class="icon is-medium">
        <i class="fas fa-book fa-lg"></i>
      </span>
      <span class='link-description'>Documentation</span>
    </a>
    <a href='http://github.com/samhinshaw/rudaux' class='card-footer-item'>
      <span class="icon is-medium">
        <i class="fab fa-github fa-lg"></i>
      </span>
      <span class='link-description'>Source Code</span>
    </a>  
  </footer>
</div>

<!-- resume content tag -->
<div class="content">

<!-- > This post is focused on the motivation and design process in building Rudaux. For information on how to use Rudaux to integrate Canvas and JupyterHub, please read _[Using Rudaux](../using-rudaux)_. -->

<h2 id='motivation'>Motivation</h2>

Rudaux was designed to be an interface for course administration that automates away a lot of the tedious functions that an instructor might otherwise have to perform. These functions are vital to keep the course running smoothly, but take up valuable time and mindshare from the instructor during the semester, when they should be focusing on instruction. Some examples of these tasks include:

- Managing assignments in the learning management system.
- Grading assignments.
- Return grades to students.

For its initial release, Rudaux was designed expressly with the UBC's new Data Science 100 course by [Tiffany Timbers](https://twitter.com/TiffanyTimbers) in mind. Therefore, we had some specific goals in mind which led us to using Canvas with JupyterHub for our teaching platform. This created the need for tools which would leverage Instructure's powerful API for Canvas to automate a great deal of course administration requirements. This automation would allow the instructor to focus on teaching, while maintaining many of the benefits that integration of Canvas & JupyterHub provide to students. In particular, it means Canvas becomes the single web address students need to think about for all of their course needs. From there, they can view their assignments, launch them in JupyterHub, and receive feedback on their graded assignments, all in one place.

## Infrastructure

<h3 id='canvas'>Canvas</h3>

[Canvas](https://www.canvaslms.com/) was the ideal choice for our Learning Management System (LMS). The University of British Columbia (UBC) is launching its installation of Canvas this fall, and it brings a whole host of features that other LMSs do not offer.

> Insert some stuff about Canvas here

<h4 id='lti-authentication'>LTI Authentication</h4>

<!-- close content tag -->
</div>

<article class="message">
  <div class="message-header" id='lti-definition-header'>
    <p>
      LTI Terminology
      <small>(click to show)</small>
    </p>
    <span class="icon">
      <i class="fas fa-chevron-down"></i>
    </span>
  </div>
  <div class="message-body" id='lti-definition-body' style="display: none;">
    <div class="content">
      <dl>
        <dt><span>LTI Consumer:</span></dt>
        <dd>The service sending the launch request. Usually this will be your LMS. In our case, this refers to Canvas.</dd>
        <dt><span>LTI Tool Provider:</span></dt>
        <dd>The service receiving the launch request, and 'providing the service'. In our case this is JupyterHub.</dt>
        <dt><span>LTI Consumer Key:</span></dt>
        <dd>A long randomly generated hex string that serves as the first half of our authentication token. This is similar to a username or a public key.</dd>
        <dt><span>LTI Consumer Secret:</span></dt>
        <dd>A long randomly generated hex string that serves as the second half of our authentication token. This is similar to a password or a private key.</dd>
        <dt><span>LTI User ID:</span></dt>
        <dd>An anonymous user ID generated by the LTI consumer.</dd>
      </dl>
    </div>
  </div>
</article>

<!-- resume content tag -->
<div class='content'>

To manage access to our JupyterHub server, we are using the [ltiauthenticator module](https://github.com/jupyterhub/ltiauthenticator) for JupyterHub written by Yuvi Panda ([@yuvipanda](https://twitter.com/yuvipanda)). This module receives LTI launch requests from LTI consumers such as Canvas and passes the user's ID to JupyterHub as a username. If the launch request contains a Canvas ID parameter, it uses that as the user's ID. Otherwise, it uses the LTI User ID (see '[Course Privacy](#course-privacy)' for more information).

For more detailed information on setting up LTI authentication between Canvas and JupyterHub, please read the [ltiauthenticator documentation](https://github.com/jupyterhub/ltiauthenticator#canvas).

<h3 id='github-repositories'>GitHub Repositories</h3>

Borrowing from the Master of Data Science Model, and to maximize compatibility with nbgrader, we chose to store all of our course documents in one private GitHub repository, and a subset of these&mdash;the student files in a public repository.

We refer to the first, private repository as our **instructors' repository**. In this repository we have the master copies of the assignments (the `source/` step of nbgrader), which contains the solutions as well as the tests. We also have the `gradebook.db` SQLite database checked-in to version control. We intend to implement a more appropriate solution for managing this in the future, but for the first run of the course, we believe it to be an acceptable solution.

Our second, public repository only contains the student copies of the assignments (the `release/` step of nbgrader). We refer to this as the **students' repository**. Each link we provide in Canvas has a query string attached which triggers nbgitpuller to sync the student's home directory to this repository and redirect them to the assignment's notebook.

<h3 id='jupyterhub-servers'>JupyterHub Servers</h3>

We use two JupyterHub servers to administer DSCI 100. These virtual machines for these servers are provisioned with Terraform, and set up with Ansible. [Ian Allison](https://github.com/ianabc) put in a tremendous amount of work setting up these servers and making their deployments programmatic and reproducible. All of the code for setting up these servers is available in our [infrastructure repository](https://github.ubc.ca/UBC-DSCI/dsc100-infra).

<h4 id='student-server'>Student Server</h4>

The first Jupyterhub server is dedicated solely to student use. Students log in by clicking on a LTI-enabled link in Canvas, and are authenticated and redirected to the notebook for that assignment. Using [dockerspawner](https://github.com/jupyterhub/dockerspawner), a docker container is spawned for each user, and their home directory is mapped to a folder on a [ZFS fileserver](#fileserver).

<h4 id='grading-server'>Grading Server</h4>

By contrast, the grading server is only accessible to the instructor and TAs. This JupyterHub server uses [Shibboleth authentication](<https://en.wikipedia.org/wiki/Shibboleth_(Shibboleth_Consortium)>) for login and access control with UBC credentials. The grading is not done on the same server that students are using, as nbgrader can be quite resource-intensive, and we do not wish to degrade students' experience.

<h4 id='fileserver'>ZFS fileserver</h4>

The directory structure of is roughly thus, where `/tank/home` is the mount point of the fileserver:

```sh
/tank/home
└── dsci100
    ├── canvas-user-id-1
    │   └── student-repo-name
    │       └── materials
    │           ├── assignment1
    │           └── assignment2
    └── canvas-user-id-2
        └── student-repo-name
            └── materials
                ├── assignment1
                └── assignment2
```

While the fileserver does not need to run a ZFS filesystem, it is advantageous for its ability to snapshot the filesystem. This allows us to take a snapshot at the exact time an assignment is due and copy from that snapshot without worry about files changing during copying.

## Rudaux Internals

Rudaux consists of 3 main parts.

1. A `Course` class, which facilitates operations on an entire course.
2. An `Assignment` class, which facilitates operations on individual assignments.
3. A command line interface, which parses common commands and runs the associated python code, without the need for the instructor to write a python script.

<h2 id='reflections'>Reflections</h2>

One of the decisions I had to make when building rudaux was where to put various functions--as a Course method or an Assignment method. One such example was the `assign()` function. At first, it might seem to be an obvious fit for an Assignment method. However, when assigning, it was necessary to clone the students' repository, copy the assinged versions of the assignment to it, and then commit and push the results. It would be wildly inefficient to do this multiple times when assigning multiple assignments in a row. Therefore, while it may have been possible to engineer a tricky solution to keep this method on the Assignment object, for simplicity I moved it to the Course object.

Another obstacle was where best to store state. I could store state within each class, but it would not be persisted through multiple script calls. Worried about keeping state in sync, for the initial release, I have opted to not persist state, and simply re-fetch fresh information at runtime.

<h2 id='looking-forward'>Looking Forward</h2>

It would be interesting to implement a `Student` class, for operations needing to be done on specific students.

Furthermore, it would be great to contribute some further functionality to the nbgrader API. Where some functionality was lacking, I simply dug into the nbgrader source code and copied the relevant portions into rudaux. However, I would much prefer the
